import{D as U,X as _,r as m,k as F,c as z,H as W,a as K,j as e,F as Z,b as X,S as Y,A as y,V as b,h as v}from"./index-DH_9BMEQ.js";import{A as $,D as P}from"./apiEndpoints-BwAEE1pY.js";import{S as G}from"./SelectComponent-CJ26kLpg.js";import{H as J}from"./HeadingPlusBackBtn-Dvv3sH3e.js";import"./BackButton-PZMohmmO.js";import"./index-CeA5IT9B.js";const w=l=>{if(!l)return"";const c=new Date(l),u=c.getFullYear(),j=String(c.getMonth()+1).padStart(2,"0"),h=String(c.getDate()).padStart(2,"0");return`${u}-${j}-${h}`},k=l=>l?new Date(l).toLocaleString("en-US",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit",hour12:!0}):"N/A",S=l=>l?new Date(l).toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",hour12:!0}):"-:--",R=()=>Intl.DateTimeFormat().resolvedOptions().timeZone;function le(){const{id:l}=U(),c=_(),[u,j]=m.useState(""),[h,q]=m.useState(""),[g,I]=m.useState(""),[p,D]=m.useState(w(new Date)),T=[{value:"Booked",label:"Booked"},{value:"Completed",label:"Completed"},{value:"Expired",label:"Expired"},{value:"Rescheduled",label:"Rescheduled"}],{data:s,isLoading:V,isError:B,error:f}=F({queryKey:["appointmentDetails",l],queryFn:async()=>{var r;if(!l)throw new Error("Appointment ID is missing.");const{data:t}=await y.get(`${$}/${l}`);return(r=t==null?void 0:t.data)==null?void 0:r.doc},enabled:!!l,staleTime:60*1e3,cacheTime:5*60*1e3,onError:t=>{b.error(`Error loading appointment details: ${v(t)}`)}});m.useEffect(()=>{var t,r;s&&(j(s.type),q((t=s.doctor)==null?void 0:t._id),I((r=s.clinic)==null?void 0:r._id),s.slot&&D(w(new Date(s.slot))))},[s]);const L=m.useMemo(()=>({status:(s==null?void 0:s.status)||"",slot:""}),[s]),M=z().shape({status:K().oneOf(["Booked","Completed","Expired","Rescheduled"],"Please select valid status").required("Status is required"),slot:W().nullable().when("status",{is:"Rescheduled",then:t=>t.required("Please select a slot for rescheduling."),otherwise:t=>t.notRequired()})}),O=async t=>{var r;try{const o={status:t.status};t.status==="Rescheduled"&&t.slot&&(o.slot=t.slot);const{data:n}=await y.patch(`${$}/${l}`,o);n!=null&&n.success&&(b.success(((r=n==null?void 0:n.data)==null?void 0:r.message)||(n==null?void 0:n.message)),c.setQueryData(["appointmentDetails",l],i=>i&&{...i,status:t.status,slot:t.status==="Rescheduled"?t.slot:i.slot}),c.invalidateQueries(["appointmentsList"]))}catch(o){b.error(v(o))}},{data:x,isLoading:H,isError:Q,error:N}=F({queryKey:["availableSlots",h,g,p,u,R()],queryFn:async()=>{var n;let t="";const r={doctor:h,date:p,timeZone:R()};if(u==="Clinic")t=`${P}/available-slots-of-clinic`,r.clinic=g;else if(u==="Online")t=`${P}/available-slots-of-online`;else throw new Error("Invalid appointment type or type not loaded.");if(!h||!p||u==="Clinic"&&!g)throw new Error("Missing required parameters for fetching slots.");const{data:o}=await y.get(t,{params:r});return(n=o==null?void 0:o.data)==null?void 0:n.doc},enabled:!!(s&&h&&p&&u&&(u!=="Clinic"||g)),staleTime:5*60*1e3,cacheTime:10*60*1e3,onError:t=>{b.error(`Error fetching slots: ${v(t)}`)}}),d=m.useMemo(()=>{if(!x||!x.slotsWithStatuses||x.slotsWithStatuses.length===0)return{morning:[],afternoon:[],evening:[]};const t=[],r=[],o=[];return x.slotsWithStatuses.forEach(n=>{if(n.isAvailable){const i=new Date(n.slot).getHours();i>=6&&i<12?t.push(n.slot):i>=12&&i<18?r.push(n.slot):(i>=18||i<6)&&o.push(n.slot)}}),{morning:t,afternoon:r,evening:o}},[x]);return e.jsx(e.Fragment,{children:e.jsxs("div",{className:"flex flex-col gap-5",children:[e.jsx("div",{className:"",children:e.jsx(J,{label:"Edit Appointment"})}),e.jsx("div",{className:"",children:V?e.jsx("p",{className:"p-5 bg-white rounded-[20px] text-center text-gray-700",children:"Loading appointment details..."}):B?e.jsxs("p",{className:"p-5 bg-white rounded-[20px] text-red-500 text-center",children:["Error:"," ",(f==null?void 0:f.message)||"Failed to load appointment."]}):s?e.jsx(Z,{initialValues:L,validationSchema:M,onSubmit:O,enableReinitialize:!0,children:t=>{var o,n,i,E,A,C;const r=((o=t==null?void 0:t.values)==null?void 0:o.status)==="Rescheduled";return e.jsxs(X,{className:"flex flex-col gap-3 bg-white p-5 rounded-[20px] shadow-lg",children:[e.jsxs("div",{className:"border border-lightBlue bg-blue-50 p-4 rounded-lg mb-6 shadow-sm",children:[e.jsx("h3",{className:"text-xl font-bold text-blue-800 mb-4 border-b pb-2 border-blue-200",children:"Current Appointment Details"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 text-gray-800 text-sm",children:[e.jsxs("div",{children:[e.jsxs("p",{children:[e.jsx("span",{className:"font-semibold",children:"Appointment ID:"})," ",s.longAutoIncrementId]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-semibold",children:"Status:"})," ",e.jsx("span",{className:`font-semibold ${s.status==="Booked"?"text-green-600":s.status==="Completed"?"text-indigo-600":s.status==="Expired"?"text-red-600":s.status==="Rescheduled"?"text-yellow-600":""}`,children:s.status})]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-semibold",children:"Type:"})," ",s.type]}),((n=s.clinic)==null?void 0:n.title)&&e.jsxs("p",{children:[e.jsx("span",{className:"font-semibold",children:"Clinic:"})," ",s.clinic.title]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-semibold",children:"Scheduled:"})," ",k(s.slot)]})]}),e.jsxs("div",{children:[e.jsxs("p",{children:[e.jsx("span",{className:"font-semibold",children:"Doctor:"})," ",(i=s.doctor)==null?void 0:i.firstName," ",(E=s.doctor)==null?void 0:E.lastName]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-semibold",children:"Pet Parent:"})," ",(A=s.petParent)==null?void 0:A.fullName]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-semibold",children:"Pet:"})," ",(C=s.pet)==null?void 0:C.name]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-semibold",children:"Symptoms:"})," ",s.symptoms||"N/A"]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-semibold",children:"Reason for Visit:"})," ",s.reasonForVisit||"N/A"]})]})]})]}),e.jsx("div",{className:"",children:e.jsx(G,{formik:t,name:"status",id:"status",label:"Update Appointment Status",options:T})}),r&&e.jsxs("div",{className:"mt-4 p-4 border border-lightBlue rounded-md bg-gray-50 shadow-inner",children:[e.jsx("h3",{className:"text-lg font-semibold mb-3 text-gray-800",children:"Reschedule Appointment"}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{htmlFor:"rescheduleDate",className:"block text-sm font-medium text-gray-700 mb-1",children:"Select New Date:"}),e.jsx("input",{type:"date",id:"rescheduleDate",name:"rescheduleDate",value:p,onChange:a=>{D(a.target.value),t.setFieldValue("slot","")},className:"mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2",min:w(new Date),onFocus:a=>a.target.showPicker()})]}),e.jsxs("h4",{className:"text-md font-medium mb-2 text-gray-800",children:["Available Slots for ",p]}),H?e.jsx("p",{className:"text-gray-600",children:"Loading available slots..."}):Q?e.jsxs("p",{className:"text-red-500",children:["Error:"," ",(N==null?void 0:N.message)||"Failed to load slots. Please try again."]}):d.morning.length===0&&d.afternoon.length===0&&d.evening.length===0?e.jsx("p",{className:"text-gray-600",children:"No available slots for the selected date."}):e.jsxs("div",{className:"grid grid-cols-3 gap-2 text-center text-sm",children:[e.jsx("div",{className:"font-bold text-gray-800",children:"Morning"}),e.jsx("div",{className:"font-bold text-gray-800",children:"Afternoon"}),e.jsx("div",{className:"font-bold text-gray-800",children:"Evening"}),e.jsx("div",{className:"flex flex-col gap-3",children:d.morning.length>0?d.morning.map(a=>e.jsx("button",{type:"button",onClick:()=>t.setFieldValue("slot",a),className:`p-2 rounded-md transition-colors shadow-sm
                                      ${t.values.slot===a?"bg-blue-600 text-white border border-blue-700":"bg-blue-100 text-blue-800 hover:bg-blue-200 border border-blue-100"}`,children:S(a)},a)):e.jsx("span",{className:"text-gray-500",children:"-:--"})}),e.jsx("div",{className:"flex flex-col gap-3",children:d.afternoon.length>0?d.afternoon.map(a=>e.jsx("button",{type:"button",onClick:()=>t.setFieldValue("slot",a),className:`p-2 rounded-md transition-colors shadow-sm
                                        ${t.values.slot===a?"bg-blue-600 text-white border border-blue-700":"bg-blue-100 text-blue-800 hover:bg-blue-200 border border-blue-100"}`,children:S(a)},a)):e.jsx("span",{className:"text-gray-500",children:"-:--"})}),e.jsx("div",{className:"flex flex-col gap-3",children:d.evening.length>0?d.evening.map(a=>e.jsx("button",{type:"button",onClick:()=>t.setFieldValue("slot",a),className:`p-2 rounded-md transition-colors shadow-sm
                                      ${t.values.slot===a?"bg-blue-600 text-white border border-blue-700":"bg-blue-100 text-blue-800 hover:bg-blue-200 border border-blue-100"}`,children:S(a)},a)):e.jsx("span",{className:"text-gray-500",children:"-:--"})})]}),t.touched.slot&&t.errors.slot&&e.jsx("div",{className:"text-red-500 text-sm mt-2",children:t.errors.slot})]}),e.jsx("div",{className:"mt-2",children:e.jsx(Y,{formik:t})})]})}}):e.jsx("p",{className:"p-5 bg-white rounded-[20px] text-center text-gray-700",children:"No appointment data found for this ID."})})]})})}export{le as default};
